name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Only run checks when relevant files change
# Skip for documentation-only changes, license, etc.
paths:
  - 'packages/**'
  - 'config/**'
  - 'scripts/**'
  - 'tests/**'
  - '.github/workflows/**'
  - '*.json'
  - '*.js'
  - '*.ts'
  - '*.yml'
  - '*.yaml'
  - 'tsconfig.json'
  - '.eslintrc.js'
  - '.prettierignore'
  - '.gitignore'
paths-ignore:
  - '**/*.md'
  - 'LICENSE'
  - 'docs/**'
  - 'business/**'
  - 'marketing/**'
  - 'strategic/**'
  - 'grafana-dashboards/**'
  - 'sre/**'

jobs:
  validate-env:
    name: Validate Environment Schema
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Validate environment variable schema
        run: |
          # Check that env schema compiles and is valid
          # tsx is available via npx or can be installed
          npx --yes tsx --check config/env.schema.ts || npm install -g tsx && tsx --check config/env.schema.ts
          echo "✅ Environment schema is valid"
      - name: Check for missing required env vars (dry-run)
        run: |
          # Run validation in dry-run mode (will show what's missing but not fail)
          # Use npx to run tsx (will install if needed)
          npx --yes tsx scripts/check-env.ts --env=production --json > env-check.json || true
          if [ -f env-check.json ]; then
            echo "Environment validation check completed"
            # Use node to parse JSON (more reliable than jq)
            node -e "try { const fs=require('fs'); const d=JSON.parse(fs.readFileSync('env-check.json')); console.log('Summary:', JSON.stringify(d.summary, null, 2)); } catch(e) { console.log('Could not parse validation results'); }" || echo "No summary available"
          else
            echo "⚠️  Could not generate validation report (this is OK in CI without real env vars)"
          fi
        continue-on-error: true

  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    needs: [validate-env]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run lint:fix -- --dry-run || true
      - run: npm run format:check
      - run: npm run typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: settler_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Run database migrations
        run: |
          cd packages/api
          npm run migrate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/settler_test
          NODE_ENV: test
          JWT_SECRET: test-secret-min-32-chars-long-for-testing
          ENCRYPTION_KEY: test-encryption-key-32-chars-long!!
        continue-on-error: true
      - run: npm run test -- --coverage
      - name: Check coverage threshold
        run: |
          COVERAGE_FILE=./packages/api/coverage/coverage-summary.json
          if [ -f "$COVERAGE_FILE" ]; then
            COVERAGE=$(node -e "const fs=require('fs'); const d=JSON.parse(fs.readFileSync('$COVERAGE_FILE')); console.log(d.total.lines.pct);")
            THRESHOLD=70
            if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
              echo "❌ Coverage $COVERAGE% is below $THRESHOLD% threshold"
              exit 1
            else
              echo "✅ Coverage $COVERAGE% meets $THRESHOLD% threshold"
            fi
          else
            echo "⚠️  Coverage file not found, skipping threshold check"
          fi
        continue-on-error: true
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./packages/api/coverage/lcov.info

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate --json > npm-audit.json || true
          npm audit --audit-level=moderate
        continue-on-error: true
      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true
      - name: Check for critical vulnerabilities
        run: |
          if [ -f npm-audit.json ]; then
            CRITICAL=$(jq -r '.vulnerabilities.critical // 0' npm-audit.json)
            if [ "$CRITICAL" -gt 0 ]; then
              echo "❌ Found $CRITICAL critical vulnerabilities - blocking merge"
              exit 1
            fi
          fi
      - name: Run Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
        continue-on-error: true

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - name: Check build artifacts
        run: |
          test -d packages/api/dist || exit 1

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: settler_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run build
      - name: Run database migrations
        run: |
          cd packages/api
          npm run migrate:prod
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/settler_test
          NODE_ENV: test
          JWT_SECRET: test-secret-min-32-chars-long-for-testing
          ENCRYPTION_KEY: test-encryption-key-32-chars-long!!
        continue-on-error: true
      - name: Start API server
        run: |
          cd packages/api
          npm start &
          sleep 5
        env:
          NODE_ENV: test
          PORT: 3000
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/settler_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-min-32-chars-long-for-testing
          ENCRYPTION_KEY: test-encryption-key-32-chars-long!!
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          E2E_API_KEY: test-api-key
          E2E_BASE_URL: http://localhost:3000

  load-test:
    name: Load Test
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: settler_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Run database migrations
        run: |
          cd packages/api
          npm run migrate
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/settler_test
          NODE_ENV: test
          JWT_SECRET: test-secret-min-32-chars-long-for-testing
          ENCRYPTION_KEY: test-encryption-key-32-chars-long!!
        continue-on-error: true
      - name: Start API server
        run: |
          cd packages/api
          npm start &
          sleep 10
        env:
          NODE_ENV: test
          PORT: 3000
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/settler_test
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-secret-min-32-chars-long-for-testing
          ENCRYPTION_KEY: test-encryption-key-32-chars-long!!
      - name: Setup k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      - name: Run 10x peak load test
        run: |
          k6 run tests/load/k6-10x-peak-load-test.js \
            -e BASE_URL=http://localhost:3000 \
            -e API_KEY=test-api-key \
            -e COST_PER_1K_REQUESTS=0.01 \
            --out json=load-test-results.json \
            --summary-export=load-test-summary.json
        continue-on-error: true
      - name: Upload load test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: load-test-results
          path: |
            load-test-results.json
            load-test-summary.json
            load-test-report.html
            load-test-summary.json
