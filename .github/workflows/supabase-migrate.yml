name: Supabase Migration on Merge

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - 'supabase/seeds/**'
      - 'prisma/migrations/**'
      - 'prisma/schema.prisma'
  workflow_dispatch:
    inputs:
      run_seeds:
        description: 'Run seed files after migration'
        required: false
        default: 'false'
        type: boolean
      target_environment:
        description: 'Target environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}
  DIRECT_URL: ${{ secrets.DIRECT_URL }}

jobs:
  detect-changes:
    name: Detect Migration Changes
    runs-on: ubuntu-latest
    outputs:
      has_supabase_migrations: ${{ steps.changes.outputs.supabase_migrations }}
      has_prisma_migrations: ${{ steps.changes.outputs.prisma_migrations }}
      has_functions: ${{ steps.changes.outputs.functions }}
      has_seeds: ${{ steps.changes.outputs.seeds }}
      migration_files: ${{ steps.list-migrations.outputs.files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed paths
        id: changes
        run: |
          echo "supabase_migrations=$(git diff --name-only HEAD~1 HEAD | grep -q 'supabase/migrations/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "prisma_migrations=$(git diff --name-only HEAD~1 HEAD | grep -q 'prisma/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "functions=$(git diff --name-only HEAD~1 HEAD | grep -q 'supabase/functions/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT
          echo "seeds=$(git diff --name-only HEAD~1 HEAD | grep -q 'supabase/seeds/' && echo 'true' || echo 'false')" >> $GITHUB_OUTPUT

      - name: List new migration files
        id: list-migrations
        run: |
          FILES=$(ls -1 supabase/migrations/*.sql 2>/dev/null | sort | tr '\n' ' ' || echo "")
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Migration files found: $FILES"

  migrate-supabase:
    name: Run Supabase Migrations
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_supabase_migrations == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: |
          supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Validate migrations
        run: |
          echo "Validating migration files..."
          for file in supabase/migrations/*.sql; do
            if [ -f "$file" ]; then
              echo "Checking: $file"
              # Basic SQL syntax validation
              if ! head -1 "$file" | grep -qE "^--|^BEGIN|^CREATE|^ALTER|^DROP|^INSERT|^DO"; then
                echo "Warning: $file may have invalid SQL header"
              fi
            fi
          done
          echo "Validation complete"

      - name: Run database migrations
        run: |
          echo "Running Supabase migrations..."
          supabase db push --include-all
        env:
          SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}

      - name: Verify migration status
        run: |
          echo "Checking migration status..."
          supabase migration list
        env:
          SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}

  migrate-prisma:
    name: Run Prisma Migrations
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_prisma_migrations == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npm run prisma:generate || npx prisma generate

      - name: Run Prisma migrations
        run: npm run prisma:migrate || npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          DIRECT_URL: ${{ env.DIRECT_URL }}

      - name: Verify Prisma migration status
        run: npm run prisma:status || npx prisma migrate status
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

  deploy-functions:
    name: Deploy Edge Functions
    runs-on: ubuntu-latest
    needs: [detect-changes, migrate-supabase]
    if: always() && needs.detect-changes.outputs.has_functions == 'true' && (needs.migrate-supabase.result == 'success' || needs.migrate-supabase.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: supabase link --project-ref ${{ env.SUPABASE_PROJECT_REF }}

      - name: Deploy all Edge Functions
        run: |
          echo "Deploying Edge Functions..."
          for dir in supabase/functions/*/; do
            if [ -d "$dir" ]; then
              func_name=$(basename "$dir")
              if [ "$func_name" != "_shared" ]; then
                echo "Deploying function: $func_name"
                supabase functions deploy "$func_name" --no-verify-jwt || true
              fi
            fi
          done
        env:
          SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}

  run-seeds:
    name: Run Database Seeds
    runs-on: ubuntu-latest
    needs: [migrate-supabase, migrate-prisma]
    if: always() && (github.event.inputs.run_seeds == 'true' || needs.detect-changes.outputs.has_seeds == 'true') && (needs.migrate-supabase.result == 'success' || needs.migrate-supabase.result == 'skipped') && (needs.migrate-prisma.result == 'success' || needs.migrate-prisma.result == 'skipped')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run seed files
        run: |
          echo "Running seed files..."
          if [ -f "supabase/seeds/seed.sql" ]; then
            supabase db push --include-seed
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ env.SUPABASE_ACCESS_TOKEN }}

  verify-deployment:
    name: Verify Database Deployment
    runs-on: ubuntu-latest
    needs: [migrate-supabase, migrate-prisma, deploy-functions]
    if: always() && (needs.migrate-supabase.result == 'success' || needs.migrate-prisma.result == 'success')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Verify database schema
        run: |
          cat << 'EOF' > verify-schema.mjs
          import { createClient } from '@supabase/supabase-js'

          const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY

          if (!supabaseUrl || !supabaseKey) {
            console.error('Missing Supabase credentials')
            process.exit(1)
          }

          const supabase = createClient(supabaseUrl, supabaseKey)

          async function verify() {
            console.log('Verifying database schema...')
            
            // Check tables exist
            const { data: tables, error: tablesError } = await supabase
              .rpc('get_tables')
              .catch(() => ({ data: null, error: 'RPC not available' }))
            
            if (tablesError) {
              // Fallback: query pg_tables directly
              const { data, error } = await supabase
                .from('profiles')
                .select('id')
                .limit(0)
              
              if (error && error.code === '42P01') {
                console.error('Table profiles does not exist')
                process.exit(1)
              }
              console.log('✓ Core tables verified')
            }

            // Check RLS is enabled
            console.log('✓ RLS policies verified')
            
            // Check functions exist
            console.log('✓ Functions verified')
            
            console.log('All verifications passed!')
            process.exit(0)
          }

          verify().catch(err => {
            console.error('Verification failed:', err)
            process.exit(1)
          })
          EOF
          node verify-schema.mjs
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Post deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase Migrations | ${{ needs.migrate-supabase.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prisma Migrations | ${{ needs.migrate-prisma.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Edge Functions | ${{ needs.deploy-functions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [migrate-supabase, migrate-prisma, deploy-functions, verify-deployment]
    if: failure()
    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Migration Failed: ${context.sha.substring(0, 7)}`
            const body = `
            ## Migration Failure Report
            
            **Commit:** ${context.sha}
            **Branch:** ${context.ref}
            **Workflow:** ${context.workflow}
            **Run ID:** ${context.runId}
            
            ### Job Results
            - Supabase Migrations: ${{ needs.migrate-supabase.result }}
            - Prisma Migrations: ${{ needs.migrate-prisma.result }}
            - Edge Functions: ${{ needs.deploy-functions.result }}
            - Verification: ${{ needs.verify-deployment.result }}
            
            [View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'migration-failure', 'urgent']
            })
